# Production-ready .htaccess for React + PHP API Project
# Secure, optimized configuration for CalFormat

# Enable Apache modules if available
<IfModule mod_rewrite.c>
    RewriteEngine On
</IfModule>

# ====================================================================
# SECURITY HEADERS
# ====================================================================
<IfModule mod_headers.c>
    # CORS Headers - Configured for your domains
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH"
    Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control, Pragma, X-CSRFToken"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Max-Age "86400"
    
    # Content Security Policy - Comprehensive for your app
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://firebase.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https: http:; media-src 'self' data: blob: https:; connect-src 'self' https://*.calformat.com https://*.myikas.com https://api.myikas.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebase.googleapis.com https://firestore.googleapis.com https://api.github.com https://api.imgbb.com; frame-src 'self' https://www.youtube.com https://player.vimeo.com; object-src 'none'; base-uri 'self'; form-action 'self';"
    
    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), bluetooth=(), accelerometer=(), gyroscope=(), magnetometer=()"
    
    # Remove server information
    Header always unset Server
    Header always unset X-Powered-By
    
    # Cache Control Headers for different file types
    <FilesMatch "\.(css|js|woff|woff2|ttf|eot|otf)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=0, must-revalidate"
    </FilesMatch>
    
    <FilesMatch "\.(json|xml)$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>
</IfModule>

# ====================================================================
# COMPRESSION
# ====================================================================
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# ====================================================================
# MIME TYPES
# ====================================================================
<IfModule mod_mime.c>
    AddType application/javascript .js
    AddType text/css .css
    AddType application/json .json
    AddType image/webp .webp
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType application/font-woff .woff
    AddType application/font-woff2 .woff2
</IfModule>

# ====================================================================
# URL REWRITING AND ROUTING
# ====================================================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Handle OPTIONS requests for CORS preflight
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # API Routes - Handle PHP API endpoints
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} ^/public/.*\.php$ [OR]
    RewriteCond %{REQUEST_URI} ^/api/
    RewriteRule ^(.*)$ $1 [L]
    
    # Static Assets - Serve directly if they exist
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^(.*)$ - [L]
    
    # React Router - All other requests go to index.html
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/public/
    RewriteCond %{REQUEST_URI} !\.php$
    RewriteRule ^(.*)$ /index.html [L]
</IfModule>

# ====================================================================
# DIRECTORY ACCESS PROTECTION
# ====================================================================
# Protect sensitive files and directories
<Files ".env">
    Order Allow,Deny
    Deny from all
</Files>

<Files ".htaccess">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.config.js">
    Order Allow,Deny
    Deny from all
</Files>

<FilesMatch "^\.">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Protect node_modules if accidentally uploaded
<IfModule mod_rewrite.c>
    RewriteRule ^node_modules/ - [F,L]
    RewriteRule ^src/ - [F,L]
    RewriteRule ^\.git/ - [F,L]
</IfModule>

# ====================================================================
# ERROR PAGES
# ====================================================================
ErrorDocument 404 /index.html
ErrorDocument 403 /index.html
ErrorDocument 500 /index.html

# ====================================================================
# PERFORMANCE OPTIMIZATIONS
# ====================================================================
# Prevent access to backup and temporary files
<FilesMatch "(^#.*#|\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
    Order Allow,Deny
    Deny from all
    Satisfy All
</FilesMatch>

# Enable Keep-Alive for better performance
<IfModule mod_headers.c>
    Header set Connection keep-alive
</IfModule>

# ====================================================================
# ADDITIONAL SECURITY MEASURES
# ====================================================================
# Disable server signature
ServerSignature Off

# Disable ETags for better caching
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>

FileETag None

# Prevent access to PHP files in uploads directory (if you have one)
<Directory "uploads">
    <Files "*.php">
        Order Allow,Deny
        Deny from all
    </Files>
</Directory>