<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipay Ödeme Seçimi - 2D / 3D Ödeme</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 500px; width: 90%; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        .header p { color: #666; font-size: 16px; }
        .payment-options { margin: 30px 0; }
        .payment-option { border: 2px solid #e1e5e9; border-radius: 10px; padding: 20px; margin: 15px 0; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .payment-option:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2); }
        .payment-option.selected { border-color: #667eea; background: #f8f9ff; }
        .payment-option input[type="radio"] { position: absolute; opacity: 0; }
        .payment-option-header { display: flex; align-items: center; margin-bottom: 10px; }
        .payment-option-icon { font-size: 24px; margin-right: 15px; }
        .payment-option-title { font-size: 20px; font-weight: 600; color: #333; }
        .payment-option-badge { background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-left: auto; }
        .payment-option-description { color: #666; font-size: 14px; line-height: 1.5; }
        .form-group { margin: 20px 0; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .submit-btn { width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; transition: transform 0.3s; margin-top: 20px; }
        .submit-btn:hover { transform: translateY(-2px); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .result { margin-top: 20px; padding: 15px; border-radius: 8px; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .result.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .loading { text-align: center; color: #667eea; }
        .comparison { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .comparison h3 { color: #333; margin-bottom: 15px; text-align: center; }
        .comparison-table { display: flex; justify-content: space-between; }
        .comparison-col { flex: 1; text-align: center; }
        .comparison-col h4 { color: #667eea; margin-bottom: 10px; }
        .comparison-col ul { list-style: none; }
        .comparison-col li { padding: 5px 0; font-size: 14px; color: #666; }
        .comparison-col li.pro { color: #28a745; }
        .comparison-col li.con { color: #dc3545; }
        @media (max-width: 768px) { .form-row { flex-direction: column; } .comparison-table { flex-direction: column; gap: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💳 Sipay Ödeme Sistemi</h1>
            <p>Güvenli ödeme için <strong>2D Hızlı</strong> veya <strong>3D Güvenli</strong> seçeneğini tercih edin</p>
        </div>

        <div class="comparison">
            <h3>🔍 Ödeme Tipi Karşılaştırması</h3>
            <div class="comparison-table">
                <div class="comparison-col">
                    <h4>2D Hızlı Ödeme</h4>
                    <ul>
                        <li class="pro">✅ Hızlı işlem (5-10 saniye)</li>
                        <li class="pro">✅ Tek adım</li>
                        <li class="pro">✅ Anında sonuç</li>
                        <li class="pro">✅ Pratik</li>
                        <li class="con">⚠️ SMS doğrulama yok</li>
                    </ul>
                </div>
                <div class="comparison-col">
                    <h4>3D Güvenli Ödeme</h4>
                    <ul>
                        <li class="pro">✅ SMS doğrulama</li>
                        <li class="pro">✅ Ekstra güvenlik katmanı</li>
                        <li class="pro">✅ Banka koruması</li>
                        <li class="pro">✅ Resmi güvenlik standardı</li>
                        <li class="con">⏱️ Biraz daha uzun sürer</li>
                    </ul>
                </div>
            </div>
        </div>

        <form id="paymentForm">
            <div class="payment-options">
                <div class="payment-option" onclick="selectPaymentType('2D')">
                    <input type="radio" name="payment_type" value="2D" id="payment2D">
                    <div class="payment-option-header">
                        <div class="payment-option-icon">⚡</div>
                        <div class="payment-option-title">2D Hızlı Ödeme</div>
                        <div class="payment-option-badge">HIZLI</div>
                    </div>
                    <div class="payment-option-description">
                        Kart bilgilerinizi girerek hızlı ödeme yapın. Tek adımda tamamlanır.
                    </div>
                </div>

                <div class="payment-option selected" onclick="selectPaymentType('3D')">
                    <input type="radio" name="payment_type" value="3D" id="payment3D" checked>
                    <div class="payment-option-header">
                        <div class="payment-option-icon">🔒</div>
                        <div class="payment-option-title">3D Güvenli Ödeme</div>
                        <div class="payment-option-badge">GÜVENLİ</div>
                    </div>
                    <div class="payment-option-description">
                        Bankanızın SMS doğrulama sistemi ile ekstra güvenlik. Önerilen seçenek.
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Kart Sahibi Adı</label>
                    <input type="text" name="cc_holder_name" value="Test User" required>
                </div>
                <div class="form-group">
                    <label>Tutar (TL)</label>
                    <input type="number" name="total" value="100.50" step="0.01" min="1" required>
                </div>
            </div>

            <div class="form-group">
                <label>Kart Numarası</label>
                <input type="text" name="cc_no" value="4444444444444448" placeholder="1234 5678 9012 3456" maxlength="19" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Son Kullanma Ayı</label>
                    <select name="expiry_month" required>
                        <option value="">Ay</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12" selected>12</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Son Kullanma Yılı</label>
                    <select name="expiry_year" required>
                        <option value="">Yıl</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>CVV</label>
                    <input type="text" name="cvv" value="123" placeholder="123" maxlength="4" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ad</label>
                    <input type="text" name="name" value="Test" required>
                </div>
                <div class="form-group">
                    <label>Soyad</label>
                    <input type="text" name="surname" value="User" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>E-posta</label>
                    <input type="email" name="bill_email" value="test@example.com" required>
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="tel" name="bill_phone" value="5551234567" required>
                </div>
            </div>

            <div class="form-group">
                <label>Taksit Sayısı</label>
                <select name="installments_number" required>
                    <option value="1" selected>Tek Çekim</option>
                    <option value="2">2 Taksit</option>
                    <option value="3">3 Taksit</option>
                    <option value="6">6 Taksit</option>
                    <option value="9">9 Taksit</option>
                    <option value="12">12 Taksit</option>
                </select>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                💳 Ödemeyi Başlat
            </button>
        </form>

        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        function selectPaymentType(type) {
            // Radio button'ları güncelle
            document.getElementById('payment2D').checked = (type === '2D');
            document.getElementById('payment3D').checked = (type === '3D');
            
            // Visual selection'ı güncelle
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            if (type === '2D') {
                document.querySelector('.payment-option:nth-child(1)').classList.add('selected');
            } else {
                document.querySelector('.payment-option:nth-child(2)').classList.add('selected');
            }
            
            // Submit button text'ini güncelle
            const submitBtn = document.getElementById('submitBtn');
            if (type === '2D') {
                submitBtn.innerHTML = '⚡ Hızlı Ödeme Yap';
            } else {
                submitBtn.innerHTML = '🔒 Güvenli Ödeme Yap';
            }
        }

        // Kart numarası formatlaması
        document.querySelector('input[name="cc_no"]').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value;
        });

        // Form submit işlemi
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const result = document.getElementById('result');
            
            // Form verilerini topla
            const formData = new FormData(this);
            const paymentData = {};
            formData.forEach((value, key) => {
                paymentData[key] = value;
            });
            
            // Kart numarasındaki boşlukları kaldır
            paymentData.cc_no = paymentData.cc_no.replace(/\s/g, '');
            
            // Ekstra veriler
            paymentData.currency_code = 'TRY';
            paymentData.invoice_id = 'TEST-' + Date.now();
            paymentData.invoice_description = 'Test Ödeme - ' + paymentData.payment_type;
            paymentData.items = JSON.stringify([{
                name: 'Test Ürün',
                price: parseFloat(paymentData.total),
                quantity: 1
            }]);
            paymentData.bill_address1 = 'Test Adres';
            paymentData.bill_city = 'İstanbul';
            paymentData.bill_state = 'İstanbul';
            paymentData.bill_postcode = '34000';
            paymentData.bill_country = 'TR';
            paymentData.cancel_url = window.location.origin + '/checkout?status=cancel';
            paymentData.return_url = window.location.origin + '/checkout?status=success';
            
            // UI güncelle
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ İşleniyor...';
            result.style.display = 'none';
            
            try {
                const response = await fetch('sipay_payment.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const responseData = await response.json();
                
                if (paymentData.payment_type === '3D' && response.headers.get('content-type')?.includes('text/html')) {
                    // 3D ödeme için HTML geldi, yönlendir
                    const htmlResponse = await fetch('sipay_payment.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    const htmlText = await htmlResponse.text();
                    
                    // Yeni pencerede 3D formu aç
                    const popup = window.open('', '_blank', 'width=600,height=700,scrollbars=yes');
                    popup.document.write(htmlText);
                    popup.document.close();
                    
                    showResult('info', '🔒 3D Güvenli Ödeme sayfası yeni pencerede açıldı. Lütfen SMS doğrulamanızı tamamlayın.');
                    
                } else if (responseData.success) {
                    // 2D ödeme başarılı
                    showResult('success', '✅ Ödeme başarıyla tamamlandı!<br>İşlem ID: ' + (responseData.data?.transaction_id || responseData.data?.order_no || 'N/A'));
                    
                } else {
                    // Hata
                    showResult('error', '❌ Ödeme başarısız: ' + (responseData.error || responseData.message || 'Bilinmeyen hata'));
                }
                
            } catch (error) {
                showResult('error', '❌ Bağlantı hatası: ' + error.message);
            }
            
            // UI'ı eski haline getir
            submitBtn.disabled = false;
            selectPaymentType(paymentData.payment_type);
        });
        
        function showResult(type, message) {
            const result = document.getElementById('result');
            result.className = 'result ' + type;
            result.innerHTML = message;
            result.style.display = 'block';
            result.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Sayfa yüklendiğinde varsayılan 3D seçili olsun
        selectPaymentType('3D');
    </script>
</body>
</html>
