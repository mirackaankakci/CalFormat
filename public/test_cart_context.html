<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Context UUID Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-section h3 { color: #007bff; margin-top: 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .product-card { border: 1px solid #eee; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›’ Cart Context UUID Testi</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ Test SenaryolarÄ±</h3>
            <p>Bu test sayfa CartContext'teki addToCart fonksiyonunun UUID formatÄ± kontrolÃ¼nÃ¼ test eder.</p>
            
            <div class="product-grid">
                <div class="product-card">
                    <h4>âœ… UUID FormatÄ±nda Product ID</h4>
                    <p><strong>ID:</strong> 8c64cc8a-7950-49e3-8739-36bcfc1db7fa</p>
                    <button onclick="testUUIDProduct()">UUID Product Ekle</button>
                </div>
                
                <div class="product-card">
                    <h4>âŒ SayÄ±sal Product ID</h4>
                    <p><strong>ID:</strong> 123</p>
                    <button onclick="testNumericProduct()">SayÄ±sal Product Ekle</button>
                </div>
                
                <div class="product-card">
                    <h4>âŒ String Product ID</h4>
                    <p><strong>ID:</strong> "product_abc"</p>
                    <button onclick="testStringProduct()">String Product Ekle</button>
                </div>
                
                <div class="product-card">
                    <h4>âŒ GeÃ§ersiz UUID</h4>
                    <p><strong>ID:</strong> "invalid-uuid-format"</p>
                    <button onclick="testInvalidUUID()">GeÃ§ersiz UUID Ekle</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ›ï¸ Sepet Ä°ÅŸlemleri</h3>
            <button onclick="showCartItems()">Sepeti GÃ¶ster</button>
            <button onclick="clearCartTest()">Sepeti Temizle</button>
            <button onclick="testOrderCreation()">SipariÅŸ OluÅŸtur</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š Test SonuÃ§larÄ±</h3>
            <div id="results"></div>
        </div>
    </div>

    <script>
        // Mock CartContext simÃ¼lasyonu
        class MockCartContext {
            constructor() {
                this.items = [];
                this.fallbackProductIds = [
                    "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                    "9d75dd9b-8061-4cde-ae23-c82657e6b5fc", 
                    "ae86eea2-9172-5def-bf34-d93768f7c6fd",
                    "bf97ffb3-a283-6e0f-cg45-ea4879g8d7ge"
                ];
            }
            
            isUUID(str) {
                return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(str);
            }
            
            addToCart(product, quantity = 1) {
                // Product ID'sinin UUID formatÄ±nda olduÄŸundan emin ol
                let productId = product.id;
                let isConverted = false;
                
                if (typeof productId === 'string' && !this.isUUID(productId)) {
                    // UUID formatÄ±nda deÄŸilse fallback kullan
                    const index = parseInt(productId.toString()) || 0;
                    productId = this.fallbackProductIds[index % this.fallbackProductIds.length];
                    isConverted = true;
                    this.log(`âš ï¸ Product ID "${product.id}" UUID formatÄ±nda deÄŸil, fallback kullanÄ±lÄ±yor: ${productId}`, 'warning');
                } else if (typeof productId === 'number') {
                    // SayÄ±sal ID ise fallback kullan
                    productId = this.fallbackProductIds[productId % this.fallbackProductIds.length];
                    isConverted = true;
                    this.log(`âš ï¸ Product ID sayÄ±sal "${product.id}", fallback kullanÄ±lÄ±yor: ${productId}`, 'warning');
                }

                const existingItemIndex = this.items.findIndex(item => item.id === productId);
                
                if (existingItemIndex !== -1) {
                    this.items[existingItemIndex].quantity += quantity;
                    this.log(`ğŸ“¦ Mevcut Ã¼rÃ¼n miktarÄ± gÃ¼ncellendi: ${this.items[existingItemIndex].name} (${this.items[existingItemIndex].quantity})`, 'info');
                } else {
                    // ÃœrÃ¼nÃ¼ UUID formatÄ±ndaki ID ile ekle
                    const productWithUUID = {
                        ...product,
                        id: productId,
                        ikasProductId: productId, // Ä°kas product ID'sini de ayarla
                        quantity
                    };
                    
                    this.items.push(productWithUUID);
                    this.log(`âœ… Yeni Ã¼rÃ¼n eklendi: ${product.name} (ID: ${productId})${isConverted ? ' [UUID\'ye Ã§evrildi]' : ''}`, 'success');
                }
                
                return { success: true, convertedToUUID: isConverted, finalId: productId };
            }
            
            clearCart() {
                this.items = [];
                this.log('ğŸ—‘ï¸ Sepet temizlendi', 'info');
            }
            
            getCartItems() {
                return this.items;
            }
            
            log(message, type = 'info') {
                console.log(message);
                this.showResult(message, type);
            }
            
            showResult(message, type) {
                const resultsDiv = document.getElementById('results');
                const resultDiv = document.createElement('div');
                resultDiv.className = `result ${type}`;
                resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                resultsDiv.appendChild(resultDiv);
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }
        }
        
        // Global cart instance
        const cart = new MockCartContext();
        
        // Test fonksiyonlarÄ±
        function testUUIDProduct() {
            const product = {
                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                name: "UUID FormatÄ±nda ÃœrÃ¼n",
                price: 100,
                image: "test.jpg",
                ikasProductId: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa"
            };
            
            const result = cart.addToCart(product, 1);
            cart.log(`ğŸ§ª UUID Test: ${JSON.stringify(result)}`, 'info');
        }
        
        function testNumericProduct() {
            const product = {
                id: 123,
                name: "SayÄ±sal ID'li ÃœrÃ¼n",
                price: 150,
                image: "test.jpg"
            };
            
            const result = cart.addToCart(product, 2);
            cart.log(`ğŸ§ª SayÄ±sal Test: ${JSON.stringify(result)}`, 'info');
        }
        
        function testStringProduct() {
            const product = {
                id: "product_abc",
                name: "String ID'li ÃœrÃ¼n",
                price: 200,
                image: "test.jpg"
            };
            
            const result = cart.addToCart(product, 1);
            cart.log(`ğŸ§ª String Test: ${JSON.stringify(result)}`, 'info');
        }
        
        function testInvalidUUID() {
            const product = {
                id: "invalid-uuid-format",
                name: "GeÃ§ersiz UUID'li ÃœrÃ¼n",
                price: 75,
                image: "test.jpg"
            };
            
            const result = cart.addToCart(product, 3);
            cart.log(`ğŸ§ª GeÃ§ersiz UUID Test: ${JSON.stringify(result)}`, 'info');
        }
        
        function showCartItems() {
            const items = cart.getCartItems();
            cart.log(`ğŸ›’ Sepetteki Ã¼rÃ¼nler (${items.length} adet):`, 'info');
            
            if (items.length === 0) {
                cart.log('Sepet boÅŸ', 'info');
                return;
            }
            
            items.forEach((item, index) => {
                cart.log(`${index + 1}. ${item.name} - ID: ${item.id} - Adet: ${item.quantity} - Fiyat: ${item.price}â‚º`, 'info');
            });
        }
        
        function clearCartTest() {
            cart.clearCart();
        }
        
        async function testOrderCreation() {
            const items = cart.getCartItems();
            
            if (items.length === 0) {
                cart.log('âŒ Sepet boÅŸ, Ã¶nce Ã¼rÃ¼n ekleyin', 'error');
                return;
            }
            
            // Mock order data
            const orderData = {
                firstName: "Test",
                lastName: "User",
                email: "test@test.com",
                phone: "5555555555",
                shippingAddress: "Test Adres",
                shippingCity: "Ä°stanbul",
                shippingDistrict: "Beykoz",
                shippingPostalCode: "34000",
                shippingCityId: "fb123456-7890-abcd-ef12-345678901001",
                shippingDistrictId: "fb123456-7890-abcd-ef12-345678901242",
                billingAddress: "Test Adres",
                billingCity: "Ä°stanbul",
                billingDistrict: "Beykoz",
                billingPostalCode: "34000",
                billingCityId: "fb123456-7890-abcd-ef12-345678901001",
                billingDistrictId: "fb123456-7890-abcd-ef12-345678901242",
                isCompany: false,
                isDifferentBillingAddress: false
            };
            
            // OrderLineItems oluÅŸtur
            const orderLineItems = items.map((item, index) => {
                return {
                    id: item.id, // ArtÄ±k UUID formatÄ±nda
                    price: Math.round(item.price),
                    variant: {
                        id: item.variantId || "7868c357-4726-432a-ad5d-49619e6a508b"
                    },
                    quantity: item.quantity
                };
            });
            
            cart.log('ğŸ“¦ SipariÅŸ oluÅŸturuluyor...', 'info');
            cart.log(`OrderLineItems: ${JSON.stringify(orderLineItems, null, 2)}`, 'info');
            
            // GerÃ§ek API Ã§aÄŸrÄ±sÄ± yapabiliriz
            try {
                const payload = {
                    input: {
                        order: {
                            orderLineItems: orderLineItems,
                            billingAddress: {
                                addressLine1: orderData.billingAddress,
                                city: {
                                    id: orderData.billingCityId,
                                    name: orderData.billingCity
                                },
                                country: {
                                    name: "TÃ¼rkiye"
                                },
                                district: {
                                    id: orderData.billingDistrictId,
                                    name: orderData.billingDistrict
                                },
                                firstName: orderData.firstName,
                                lastName: orderData.lastName,
                                isDefault: false
                            },
                            shippingAddress: {
                                addressLine1: orderData.shippingAddress,
                                city: {
                                    id: orderData.shippingCityId,
                                    name: orderData.shippingCity
                                },
                                country: {
                                    name: "TÃ¼rkiye"
                                },
                                district: {
                                    id: orderData.shippingDistrictId,
                                    name: orderData.shippingDistrict
                                },
                                firstName: orderData.firstName,
                                lastName: orderData.lastName,
                                phone: orderData.phone,
                                isDefault: false
                            },
                            note: "UUID test sipariÅŸi",
                            deleted: false,
                            customer: {
                                lastName: orderData.lastName,
                                firstName: orderData.firstName,
                                email: orderData.email
                            }
                        }
                    }
                };
                
                cart.log('ğŸš€ API\'ye gÃ¶nderilecek payload:', 'info');
                cart.log(JSON.stringify(payload, null, 2), 'info');
                
                const response = await fetch('/ikas_create_order_new.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    cart.log('âœ… SipariÅŸ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                    cart.log(JSON.stringify(result, null, 2), 'success');
                } else {
                    cart.log('âŒ SipariÅŸ oluÅŸturulamadÄ±:', 'error');
                    cart.log(JSON.stringify(result, null, 2), 'error');
                }
                
            } catch (error) {
                cart.log(`âŒ API HatasÄ±: ${error.message}`, 'error');
            }
        }
        
        // Sayfa yÃ¼klendiÄŸinde hoÅŸ geldin mesajÄ±
        document.addEventListener('DOMContentLoaded', function() {
            cart.log('ğŸš€ Cart Context UUID Test baÅŸlatÄ±ldÄ±', 'info');
            cart.log('ğŸ” Test senaryolarÄ±nÄ± kullanarak farklÄ± ID formatlarÄ±nÄ± test edebilirsiniz', 'info');
        });
    </script>
</body>
</html>
