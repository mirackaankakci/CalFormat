<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°kas SipariÅŸ API - DÃ¼zeltilmiÅŸ Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 5px; 
            background: #f9f9f9;
        }
        .test-section h3 { 
            margin: 0 0 15px 0; 
            color: #333; 
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
        }
        .test-button { 
            background: #007bff; 
            color: white; 
            padding: 12px 25px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px;
            font-size: 14px;
        }
        .test-button:hover { background: #0056b3; }
        .test-button.success { background: #28a745; }
        .test-button.danger { background: #dc3545; }
        .result { 
            background: #f0f0f0; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            border-left: 4px solid #007bff;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success { border-left-color: #28a745; background: #d4edda; }
        .result.error { border-left-color: #dc3545; background: #f8d7da; }
        .payload-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .info { 
            background: #d1ecf1; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
            border-left: 4px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœ… Ä°kas SipariÅŸ API - DÃ¼zeltilmiÅŸ Test</h1>
        
        <div class="warning">
            <strong>âš ï¸ Tespit Edilen Hatalar:</strong><br>
            1. Åehir ve Ã¼lke bilgileri karÄ±ÅŸÄ±ktÄ± (city: "TÃ¼rkiye", country: "Ä°stanbul")<br>
            2. Eksik adres alanlarÄ± (addressLine2, zipCode, district)<br>
            3. MÃ¼ÅŸteri transaction tutarÄ± Ã§ok dÃ¼ÅŸÃ¼k (4 TL)<br>
            4. GraphQL mutation eksik alanlar
        </div>

        <div class="info">
            <strong>âœ… DÃ¼zeltmeler:</strong><br>
            âœ… Åehir: "Ä°stanbul", Ãœlke: "TÃ¼rkiye" olarak dÃ¼zeltildi<br>
            âœ… TÃ¼m adres alanlarÄ± eklendi (addressLine2, zipCode, district)<br>
            âœ… GerÃ§ekÃ§i fiyat hesaplamasÄ± (100 TL x 2 adet + kargo)<br>
            âœ… GraphQL mutation tÃ¼m alanlarla geniÅŸletildi<br>
            âœ… Fallback mekanizmasÄ± gÃ¼Ã§lendirildi
        </div>

        <div class="test-section">
            <h3>1. DÃ¼zeltilmiÅŸ SipariÅŸ Testi</h3>
            <p>DoÄŸru formatta sipariÅŸ oluÅŸturma testi</p>
            <button class="test-button" onclick="testCorrectOrder()">DoÄŸru SipariÅŸ Test Et</button>
            <div id="result-correct" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>2. GerÃ§ekÃ§i SipariÅŸ Testi</h3>
            <p>GerÃ§ek mÃ¼ÅŸteri bilgileri ile test</p>
            <button class="test-button" onclick="testRealisticOrder()">GerÃ§ekÃ§i SipariÅŸ Test Et</button>
            <div id="result-realistic" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>3. Ã‡oklu ÃœrÃ¼n Testi</h3>
            <p>Birden fazla Ã¼rÃ¼n ile sipariÅŸ testi</p>
            <button class="test-button" onclick="testMultipleItems()">Ã‡oklu ÃœrÃ¼n Test Et</button>
            <div id="result-multiple" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>4. Kargo Hesaplama Testi</h3>
            <p>FarklÄ± tutarlarda kargo hesaplama testi</p>
            <button class="test-button" onclick="testShippingCalculation()">Kargo Hesaplama Test Et</button>
            <div id="result-shipping" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>5. DoÄŸru Payload GÃ¶rÃ¼ntÃ¼leyici</h3>
            <p>DÃ¼zeltilmiÅŸ sipariÅŸ payload'Ä±</p>
            <button class="test-button success" onclick="showCorrectPayload()">DoÄŸru Payload GÃ¶ster</button>
            <div id="payload-correct" class="payload-display" style="display:none;"></div>
        </div>
    </div>

    <script>
        // DoÄŸru sipariÅŸ payload oluÅŸturma fonksiyonu
        function createCorrectOrderPayload(customData = {}) {
            const defaultPayload = {
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 100, // GerÃ§ekÃ§i fiyat
                                variant: {
                                    id: "7868c357-4726-432a-ad5d-49619e6a508b"
                                },
                                quantity: 2
                            }
                        ],
                        billingAddress: {
                            addressLine1: "TokatkÃ¶y Mah. Sultan Aziz Cad.",
                            addressLine2: "No: 123 Daire: 5", // Eklendi
                            city: {
                                id: "34", // Ä°stanbul il kodu
                                name: "Ä°stanbul" // DÃ¼zeltildi
                            },
                            country: {
                                name: "TÃ¼rkiye" // DÃ¼zeltildi
                            },
                            district: {
                                id: "34-020", // Beykoz ilÃ§e kodu
                                name: "Beykoz" // Eklendi
                            },
                            firstName: "MiraÃ§ Kaan",
                            lastName: "KakcÄ±",
                            zipCode: "34820", // Eklendi
                            isDefault: false
                        },
                        shippingAddress: {
                            addressLine1: "TokatkÃ¶y Mah. Sultan Aziz Cad.",
                            addressLine2: "No: 123 Daire: 5", // Eklendi
                            city: {
                                id: "34", // Ä°stanbul il kodu
                                name: "Ä°stanbul" // DÃ¼zeltildi
                            },
                            country: {
                                name: "TÃ¼rkiye" // DÃ¼zeltildi
                            },
                            district: {
                                id: "34-020", // Beykoz ilÃ§e kodu
                                name: "Beykoz"
                            },
                            firstName: "MiraÃ§ Kaan",
                            lastName: "KakcÄ±",
                            phone: "05355570405",
                            zipCode: "34820", // Eklendi
                            isDefault: false
                        },
                        note: "test sipariÅŸi",
                        deleted: false,
                        customer: {
                            lastName: "KakcÄ±",
                            firstName: "MiraÃ§ Kaan",
                            email: "kaankakci2@gmail.com"
                        }
                    },
                    transactions: [
                        {
                            amount: 230 // 100*2 + 30 kargo = 230 TL (gerÃ§ekÃ§i)
                        }
                    ]
                }
            };

            // Custom data ile merge et
            return { ...defaultPayload, ...customData };
        }

        async function makeAPIRequest(payload, testName) {
            const startTime = Date.now();
            
            try {
                console.log(`ğŸš€ ${testName} baÅŸlatÄ±ldÄ±...`);
                
                const response = await fetch('/ikas_create_order.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'omit',
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(30000)
                });

                const responseTime = Date.now() - startTime;
                const responseText = await response.text();
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    result = {
                        error: 'JSON Parse Error',
                        raw_response: responseText.substring(0, 500),
                        parse_error: parseError.message
                    };
                }

                return {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    responseTime: responseTime,
                    data: result,
                    headers: Object.fromEntries(response.headers.entries())
                };

            } catch (error) {
                const responseTime = Date.now() - startTime;
                return {
                    success: false,
                    error: error.message,
                    responseTime: responseTime
                };
            }
        }

        async function testCorrectOrder() {
            const resultDiv = document.getElementById('result-correct');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'â³ DÃ¼zeltilmiÅŸ sipariÅŸ test ediliyor...';

            const payload = createCorrectOrderPayload();
            const result = await makeAPIRequest(payload, 'DÃ¼zeltilmiÅŸ SipariÅŸ');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `ğŸ“Š DÃ¼zeltilmiÅŸ SipariÅŸ Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

ğŸ” DÃ¼zeltilen Hatalar:
âœ… Åehir/Ãœlke bilgileri dÃ¼zeltildi
âœ… Eksik adres alanlarÄ± eklendi
âœ… GerÃ§ekÃ§i fiyat hesaplamasÄ±
âœ… GraphQL mutation geniÅŸletildi

Response Data:
${JSON.stringify(result.data, null, 2)}

${result.data?.success ? 'ğŸ‰ SipariÅŸ baÅŸarÄ±yla oluÅŸturuldu!' : 'âŒ Hata oluÅŸtu'}
${result.data?.fallback_mode ? 'âš ï¸ Fallback mode devrede' : ''}`;
        }

        async function testRealisticOrder() {
            const resultDiv = document.getElementById('result-realistic');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'â³ GerÃ§ekÃ§i sipariÅŸ test ediliyor...';

            const realisticPayload = createCorrectOrderPayload({
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 299, // CalFormat Ã¼rÃ¼n fiyatÄ±
                                variant: {
                                    id: "7868c357-4726-432a-ad5d-49619e6a508b"
                                },
                                quantity: 1
                            }
                        ],
                        billingAddress: {
                            addressLine1: "AtatÃ¼rk Caddesi No: 45",
                            addressLine2: "Apt: Park Residence Daire: 12",
                            city: { 
                                id: "34", // Ä°stanbul il kodu
                                name: "Ä°stanbul" 
                            },
                            country: { name: "TÃ¼rkiye" },
                            district: { 
                                id: "34-025", // ÅiÅŸli ilÃ§e kodu
                                name: "ÅiÅŸli" 
                            },
                            firstName: "Ahmet",
                            lastName: "YÄ±lmaz",
                            zipCode: "34394",
                            isDefault: false
                        },
                        shippingAddress: {
                            addressLine1: "Ä°ÅŸ Merkezi 42. Sokak",
                            addressLine2: "Plaza A Blok Kat: 5",
                            city: { 
                                id: "34", // Ä°stanbul il kodu
                                name: "Ä°stanbul" 
                            },
                            country: { name: "TÃ¼rkiye" },
                            district: { 
                                id: "34-024", // Levent (BeÅŸiktaÅŸ alt ilÃ§esi)
                                name: "Levent" 
                            },
                            firstName: "Ahmet",
                            lastName: "YÄ±lmaz",
                            phone: "05321234567",
                            zipCode: "34330",
                            isDefault: false
                        },
                        note: "Ofise teslimat, 09:00-17:00 arasÄ±",
                        deleted: false,
                        customer: {
                            lastName: "YÄ±lmaz",
                            firstName: "Ahmet",
                            email: "ahmet.yilmaz@example.com"
                        }
                    },
                    transactions: [
                        {
                            amount: 329 // 299 + 30 kargo
                        }
                    ]
                }
            });

            const result = await makeAPIRequest(realisticPayload, 'GerÃ§ekÃ§i SipariÅŸ');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `ğŸ“Š GerÃ§ekÃ§i SipariÅŸ Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

ğŸ¢ GerÃ§ekÃ§i Senaryo:
- CalFormat takvim Ã¼rÃ¼nÃ¼
- FarklÄ± fatura/teslimat adresi
- Ofis teslimatÄ±
- Notlu sipariÅŸ

Response Data:
${JSON.stringify(result.data, null, 2)}`;
        }

        async function testMultipleItems() {
            const resultDiv = document.getElementById('result-multiple');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'â³ Ã‡oklu Ã¼rÃ¼n testi yapÄ±lÄ±yor...';

            const multiPayload = createCorrectOrderPayload({
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 299,
                                variant: { id: "7868c357-4726-432a-ad5d-49619e6a508b" },
                                quantity: 2
                            },
                            {
                                id: "future-product-wall-calendar",
                                price: 199,
                                variant: { id: "variant-wall-calendar-2025" },
                                quantity: 1
                            }
                        ],
                        // ... aynÄ± adres bilgileri
                    },
                    transactions: [
                        {
                            amount: 827 // (299*2) + 199 + 30 kargo = 827
                        }
                    ]
                }
            });

            const result = await makeAPIRequest(multiPayload, 'Ã‡oklu ÃœrÃ¼n');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `ğŸ“Š Ã‡oklu ÃœrÃ¼n Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

ğŸ›ï¸ Ã‡oklu ÃœrÃ¼n:
- 2x CalFormat Premium (299â‚º)
- 1x Duvar Takvimi (199â‚º)
- Kargo: 30â‚º
- Toplam: 827â‚º

Response Data:
${JSON.stringify(result.data, null, 2)}`;
        }

        async function testShippingCalculation() {
            const resultDiv = document.getElementById('result-shipping');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'â³ Kargo hesaplama testi yapÄ±lÄ±yor...';

            // Ãœcretsiz kargo testi (150â‚º Ã¼zeri)
            const freeShippingPayload = createCorrectOrderPayload({
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 299,
                                variant: { id: "7868c357-4726-432a-ad5d-49619e6a508b" },
                                quantity: 1
                            }
                        ]
                    },
                    transactions: [
                        {
                            amount: 299 // Kargo Ã¼cretsiz olmalÄ± (150â‚º Ã¼zeri)
                        }
                    ]
                }
            });

            const result = await makeAPIRequest(freeShippingPayload, 'Ãœcretsiz Kargo');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `ğŸ“Š Kargo Hesaplama Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

ğŸ“¦ Kargo Hesaplama:
- ÃœrÃ¼n TutarÄ±: 299â‚º
- 150â‚º Ã¼zeri Ã¼cretsiz kargo
- Kargo: 0â‚º (Ã¼cretsiz)
- Toplam: 299â‚º

Response Data:
${JSON.stringify(result.data, null, 2)}`;
        }

        function showCorrectPayload() {
            const payloadDiv = document.getElementById('payload-correct');
            payloadDiv.style.display = 'block';

            const correctPayload = createCorrectOrderPayload();

            payloadDiv.textContent = `ğŸ“¦ DÃ¼zeltilmiÅŸ Ä°kas SipariÅŸ Payload:

${JSON.stringify(correctPayload, null, 2)}

ğŸ” DÃ¼zeltilen Hatalar:
âœ… city: "Ä°stanbul" (Ã¶nceden "TÃ¼rkiye" yanlÄ±ÅŸÄ±)
âœ… country: "TÃ¼rkiye" (Ã¶nceden "Ä°stanbul" yanlÄ±ÅŸÄ±)
âœ… addressLine2 eklendi
âœ… zipCode eklendi
âœ… district bilgisi dÃ¼zenlendi
âœ… GerÃ§ekÃ§i amount (230â‚º = 100*2 + 30 kargo)

ğŸ“‹ GraphQL Mutation:
mutation CreateOrderWithTransactions($input: CreateOrderWithTransactionsInput!) {
  createOrderWithTransactions(input: $input) {
    id
    orderNumber
    totalAmount
    status
    customer { id email firstName lastName }
    orderLineItems {
      id quantity price
      variant { id sku product { id name } }
    }
    billingAddress {
      firstName lastName addressLine1 addressLine2
      city { id name } country { name } district { id name }
      zipCode isDefault
    }
    shippingAddress {
      firstName lastName addressLine1 addressLine2
      city { id name } country { name } district { id name }
      phone zipCode isDefault
    }
    transactions { id amount status transactionType }
    note deleted createdAt updatedAt
  }
}`;
        }

        // Sayfa yÃ¼klendiÄŸinde
        console.log('âœ… Ä°kas SipariÅŸ API - DÃ¼zeltilmiÅŸ test sayfasÄ± yÃ¼klendi');
        console.log('ğŸš€ Testleri baÅŸlatmak iÃ§in butonlara tÄ±klayÄ±n');
    </script>
</body>
</html>
