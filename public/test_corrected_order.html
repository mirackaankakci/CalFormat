<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞kas Sipari≈ü API - D√ºzeltilmi≈ü Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 5px; 
            background: #f9f9f9;
        }
        .test-section h3 { 
            margin: 0 0 15px 0; 
            color: #333; 
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
        }
        .test-button { 
            background: #007bff; 
            color: white; 
            padding: 12px 25px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px;
            font-size: 14px;
        }
        .test-button:hover { background: #0056b3; }
        .test-button.success { background: #28a745; }
        .test-button.danger { background: #dc3545; }
        .result { 
            background: #f0f0f0; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            border-left: 4px solid #007bff;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success { border-left-color: #28a745; background: #d4edda; }
        .result.error { border-left-color: #dc3545; background: #f8d7da; }
        .payload-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .info { 
            background: #d1ecf1; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
            border-left: 4px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ ƒ∞kas Sipari≈ü API - D√ºzeltilmi≈ü Test</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Tespit Edilen Hatalar:</strong><br>
            1. ≈ûehir ve √ºlke bilgileri karƒ±≈üƒ±ktƒ± (city: "T√ºrkiye", country: "ƒ∞stanbul")<br>
            2. Eksik adres alanlarƒ± (addressLine2, zipCode, district)<br>
            3. M√º≈üteri transaction tutarƒ± √ßok d√º≈ü√ºk (4 TL)<br>
            4. GraphQL mutation eksik alanlar
        </div>

        <div class="info">
            <strong>‚úÖ D√ºzeltmeler:</strong><br>
            ‚úÖ ≈ûehir: "ƒ∞stanbul", √úlke: "T√ºrkiye" olarak d√ºzeltildi<br>
            ‚úÖ T√ºm adres alanlarƒ± eklendi (addressLine2, zipCode, district)<br>
            ‚úÖ Ger√ßek√ßi fiyat hesaplamasƒ± (100 TL x 2 adet + kargo)<br>
            ‚úÖ GraphQL mutation t√ºm alanlarla geni≈ületildi<br>
            ‚úÖ Fallback mekanizmasƒ± g√º√ßlendirildi
        </div>

        <div class="test-section">
            <h3>1. D√ºzeltilmi≈ü Sipari≈ü Testi</h3>
            <p>Doƒüru formatta sipari≈ü olu≈üturma testi</p>
            <button class="test-button" onclick="testCorrectOrder()">Doƒüru Sipari≈ü Test Et</button>
            <div id="result-correct" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>2. Ger√ßek√ßi Sipari≈ü Testi</h3>
            <p>Ger√ßek m√º≈üteri bilgileri ile test</p>
            <button class="test-button" onclick="testRealisticOrder()">Ger√ßek√ßi Sipari≈ü Test Et</button>
            <div id="result-realistic" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>3. √áoklu √úr√ºn Testi</h3>
            <p>Birden fazla √ºr√ºn ile sipari≈ü testi</p>
            <button class="test-button" onclick="testMultipleItems()">√áoklu √úr√ºn Test Et</button>
            <div id="result-multiple" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>4. Kargo Hesaplama Testi</h3>
            <p>Farklƒ± tutarlarda kargo hesaplama testi</p>
            <button class="test-button" onclick="testShippingCalculation()">Kargo Hesaplama Test Et</button>
            <div id="result-shipping" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>5. Doƒüru Payload G√∂r√ºnt√ºleyici</h3>
            <p>D√ºzeltilmi≈ü sipari≈ü payload'ƒ±</p>
            <button class="test-button success" onclick="showCorrectPayload()">Doƒüru Payload G√∂ster</button>
            <div id="payload-correct" class="payload-display" style="display:none;"></div>
        </div>
    </div>

    <script>
        // Doƒüru sipari≈ü payload olu≈üturma fonksiyonu
        function createCorrectOrderPayload(customData = {}) {
            const defaultPayload = {
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 100, // Ger√ßek√ßi fiyat
                                variant: {
                                    id: "7868c357-4726-432a-ad5d-49619e6a508b"
                                },
                                quantity: 2
                            }
                        ],
                        billingAddress: {
                            addressLine1: "Tokatk√∂y Mah. Sultan Aziz Cad.",
                            addressLine2: "No: 123 Daire: 5", // Eklendi
                            city: {
                                id: "34", // ƒ∞stanbul il kodu
                                name: "ƒ∞stanbul" // D√ºzeltildi
                            },
                            country: {
                                name: "T√ºrkiye" // D√ºzeltildi
                            },
                            district: {
                                id: "34-020", // Beykoz il√ße kodu
                                name: "Beykoz" // Eklendi
                            },
                            firstName: "Mira√ß Kaan",
                            lastName: "Kakcƒ±",
                            zipCode: "34820", // Eklendi
                            isDefault: false
                        },
                        shippingAddress: {
                            addressLine1: "Tokatk√∂y Mah. Sultan Aziz Cad.",
                            addressLine2: "No: 123 Daire: 5", // Eklendi
                            city: {
                                id: "34", // ƒ∞stanbul il kodu
                                name: "ƒ∞stanbul" // D√ºzeltildi
                            },
                            country: {
                                name: "T√ºrkiye" // D√ºzeltildi
                            },
                            district: {
                                id: "34-020", // Beykoz il√ße kodu
                                name: "Beykoz"
                            },
                            firstName: "Mira√ß Kaan",
                            lastName: "Kakcƒ±",
                            phone: "05355570405",
                            zipCode: "34820", // Eklendi
                            isDefault: false
                        },
                        note: "test sipari≈üi",
                        deleted: false,
                        customer: {
                            lastName: "Kakcƒ±",
                            firstName: "Mira√ß Kaan",
                            email: "kaankakci2@gmail.com"
                        }
                    },
                    transactions: [
                        {
                            amount: 230 // 100*2 + 30 kargo = 230 TL (ger√ßek√ßi)
                        }
                    ]
                }
            };

            // Custom data ile merge et
            return { ...defaultPayload, ...customData };
        }

        async function makeAPIRequest(payload, testName) {
            const startTime = Date.now();
            
            try {
                console.log(`üöÄ ${testName} ba≈ülatƒ±ldƒ±...`);
                
                const response = await fetch('/ikas_create_order.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'omit',
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(30000)
                });

                const responseTime = Date.now() - startTime;
                const responseText = await response.text();
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    result = {
                        error: 'JSON Parse Error',
                        raw_response: responseText.substring(0, 500),
                        parse_error: parseError.message
                    };
                }

                return {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    responseTime: responseTime,
                    data: result,
                    headers: Object.fromEntries(response.headers.entries())
                };

            } catch (error) {
                const responseTime = Date.now() - startTime;
                return {
                    success: false,
                    error: error.message,
                    responseTime: responseTime
                };
            }
        }

        async function testCorrectOrder() {
            const resultDiv = document.getElementById('result-correct');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '‚è≥ D√ºzeltilmi≈ü sipari≈ü test ediliyor...';

            const payload = createCorrectOrderPayload();
            const result = await makeAPIRequest(payload, 'D√ºzeltilmi≈ü Sipari≈ü');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `üìä D√ºzeltilmi≈ü Sipari≈ü Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

üîç D√ºzeltilen Hatalar:
‚úÖ ≈ûehir/√úlke bilgileri d√ºzeltildi
‚úÖ Eksik adres alanlarƒ± eklendi
‚úÖ Ger√ßek√ßi fiyat hesaplamasƒ±
‚úÖ GraphQL mutation geni≈ületildi

Response Data:
${JSON.stringify(result.data, null, 2)}

${result.data?.success ? 'üéâ Sipari≈ü ba≈üarƒ±yla olu≈üturuldu!' : '‚ùå Hata olu≈ütu'}
${result.data?.fallback_mode ? '‚ö†Ô∏è Fallback mode devrede' : ''}`;
        }

        async function testRealisticOrder() {
            const resultDiv = document.getElementById('result-realistic');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '‚è≥ Ger√ßek√ßi sipari≈ü test ediliyor...';

            const realisticPayload = createCorrectOrderPayload({
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 299, // CalFormat √ºr√ºn fiyatƒ±
                                variant: {
                                    id: "7868c357-4726-432a-ad5d-49619e6a508b"
                                },
                                quantity: 1
                            }
                        ],
                        billingAddress: {
                            addressLine1: "Atat√ºrk Caddesi No: 45",
                            addressLine2: "Apt: Park Residence Daire: 12",
                            city: { 
                                id: "34", // ƒ∞stanbul il kodu
                                name: "ƒ∞stanbul" 
                            },
                            country: { name: "T√ºrkiye" },
                            district: { 
                                id: "34-025", // ≈ûi≈üli il√ße kodu
                                name: "≈ûi≈üli" 
                            },
                            firstName: "Ahmet",
                            lastName: "Yƒ±lmaz",
                            zipCode: "34394",
                            isDefault: false
                        },
                        shippingAddress: {
                            addressLine1: "ƒ∞≈ü Merkezi 42. Sokak",
                            addressLine2: "Plaza A Blok Kat: 5",
                            city: { 
                                id: "34", // ƒ∞stanbul il kodu
                                name: "ƒ∞stanbul" 
                            },
                            country: { name: "T√ºrkiye" },
                            district: { 
                                id: "34-024", // Levent (Be≈üikta≈ü alt il√ßesi)
                                name: "Levent" 
                            },
                            firstName: "Ahmet",
                            lastName: "Yƒ±lmaz",
                            phone: "05321234567",
                            zipCode: "34330",
                            isDefault: false
                        },
                        note: "Ofise teslimat, 09:00-17:00 arasƒ±",
                        deleted: false,
                        customer: {
                            lastName: "Yƒ±lmaz",
                            firstName: "Ahmet",
                            email: "ahmet.yilmaz@example.com"
                        }
                    },
                    transactions: [
                        {
                            amount: 329 // 299 + 30 kargo
                        }
                    ]
                }
            });

            const result = await makeAPIRequest(realisticPayload, 'Ger√ßek√ßi Sipari≈ü');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `üìä Ger√ßek√ßi Sipari≈ü Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

üè¢ Ger√ßek√ßi Senaryo:
- CalFormat takvim √ºr√ºn√º
- Farklƒ± fatura/teslimat adresi
- Ofis teslimatƒ±
- Notlu sipari≈ü

Response Data:
${JSON.stringify(result.data, null, 2)}`;
        }

        async function testMultipleItems() {
            const resultDiv = document.getElementById('result-multiple');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '‚è≥ √áoklu √ºr√ºn testi yapƒ±lƒ±yor...';

            const multiPayload = createCorrectOrderPayload({
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 299,
                                variant: { id: "7868c357-4726-432a-ad5d-49619e6a508b" },
                                quantity: 2
                            },
                            {
                                id: "future-product-wall-calendar",
                                price: 199,
                                variant: { id: "variant-wall-calendar-2025" },
                                quantity: 1
                            }
                        ],
                        // ... aynƒ± adres bilgileri
                    },
                    transactions: [
                        {
                            amount: 827 // (299*2) + 199 + 30 kargo = 827
                        }
                    ]
                }
            });

            const result = await makeAPIRequest(multiPayload, '√áoklu √úr√ºn');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `üìä √áoklu √úr√ºn Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

üõçÔ∏è √áoklu √úr√ºn:
- 2x CalFormat Premium (299‚Ç∫)
- 1x Duvar Takvimi (199‚Ç∫)
- Kargo: 30‚Ç∫
- Toplam: 827‚Ç∫

Response Data:
${JSON.stringify(result.data, null, 2)}`;
        }

        async function testShippingCalculation() {
            const resultDiv = document.getElementById('result-shipping');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '‚è≥ Kargo hesaplama testi yapƒ±lƒ±yor...';

            // √úcretsiz kargo testi (150‚Ç∫ √ºzeri)
            const freeShippingPayload = createCorrectOrderPayload({
                input: {
                    order: {
                        orderLineItems: [
                            {
                                id: "8c64cc8a-7950-49e3-8739-36bcfc1db7fa",
                                price: 299,
                                variant: { id: "7868c357-4726-432a-ad5d-49619e6a508b" },
                                quantity: 1
                            }
                        ]
                    },
                    transactions: [
                        {
                            amount: 299 // Kargo √ºcretsiz olmalƒ± (150‚Ç∫ √ºzeri)
                        }
                    ]
                }
            });

            const result = await makeAPIRequest(freeShippingPayload, '√úcretsiz Kargo');
            
            resultDiv.className = result.success ? 'result success' : 'result error';
            resultDiv.textContent = `üìä Kargo Hesaplama Test Sonucu (${result.responseTime}ms):
            
Status: ${result.status} ${result.statusText}
Success: ${result.success}

üì¶ Kargo Hesaplama:
- √úr√ºn Tutarƒ±: 299‚Ç∫
- 150‚Ç∫ √ºzeri √ºcretsiz kargo
- Kargo: 0‚Ç∫ (√ºcretsiz)
- Toplam: 299‚Ç∫

Response Data:
${JSON.stringify(result.data, null, 2)}`;
        }

        function showCorrectPayload() {
            const payloadDiv = document.getElementById('payload-correct');
            payloadDiv.style.display = 'block';

            const correctPayload = createCorrectOrderPayload();

            payloadDiv.textContent = `üì¶ D√ºzeltilmi≈ü ƒ∞kas Sipari≈ü Payload:

${JSON.stringify(correctPayload, null, 2)}

üîç D√ºzeltilen Hatalar:
‚úÖ city: "ƒ∞stanbul" (√∂nceden "T√ºrkiye" yanlƒ±≈üƒ±)
‚úÖ country: "T√ºrkiye" (√∂nceden "ƒ∞stanbul" yanlƒ±≈üƒ±)
‚úÖ addressLine2 eklendi
‚úÖ zipCode eklendi
‚úÖ district bilgisi d√ºzenlendi
‚úÖ Ger√ßek√ßi amount (230‚Ç∫ = 100*2 + 30 kargo)

üìã GraphQL Mutation:
mutation CreateOrderWithTransactions($input: CreateOrderWithTransactionsInput!) {
  createOrderWithTransactions(input: $input) {
    id
    orderNumber
    totalAmount
    status
    customer { id email firstName lastName }
    orderLineItems {
      id quantity price
      variant { id sku product { id name } }
    }
    billingAddress {
      firstName lastName addressLine1 addressLine2
      city { id name } country { name } district { id name }
      zipCode isDefault
    }
    shippingAddress {
      firstName lastName addressLine1 addressLine2
      city { id name } country { name } district { id name }
      phone zipCode isDefault
    }
    transactions { id amount status transactionType }
    note deleted createdAt updatedAt
  }
}`;
        }

        // Sayfa y√ºklendiƒüinde
        console.log('‚úÖ ƒ∞kas Sipari≈ü API - D√ºzeltilmi≈ü test sayfasƒ± y√ºklendi');
        console.log('üöÄ Testleri ba≈ülatmak i√ßin butonlara tƒ±klayƒ±n');
    </script>
</body>
</html>
