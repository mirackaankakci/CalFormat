<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiPay Test - CalFormat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a87; }
        .section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <h1>SiPay Ödeme Sistemi Test</h1>
    <p>Bu sayfada SiPay entegrasyonunu test edebilirsiniz.</p>

    <!-- DNS Test -->
    <div class="section">
        <h2>1. Domain DNS Kontrolü</h2>
        <div id="dns-result" class="result info">
            <strong>DNS Durumu:</strong> ✅ calformat.com domain'i çalışıyor! 
            <br>SiPay ödeme sistemi hazır.
        </div>
    </div>

    <!-- 2D Ödeme Test -->
    <div class="section">
        <h2>2. 2D Ödeme Testi</h2>
        <form id="payment2dForm">
            <div class="form-group">
                <label>Tutar (TL):</label>
                <input type="number" id="amount2d" value="1.00" step="0.01" min="0.01">
            </div>
            
            <h3>Müşteri Bilgileri</h3>
            <div class="form-group">
                <label>Ad:</label>
                <input type="text" id="customerName2d" value="Test" required>
            </div>
            <div class="form-group">
                <label>Soyad:</label>
                <input type="text" id="customerSurname2d" value="Müşteri" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="customerEmail2d" value="test@calformat.com" required>
            </div>
            <div class="form-group">
                <label>Telefon:</label>
                <input type="text" id="customerPhone2d" value="05551234567" required>
            </div>
            <div class="form-group">
                <label>Adres:</label>
                <input type="text" id="customerAddress2d" value="Test Adresi 123" required>
            </div>
            <div class="form-group">
                <label>Şehir:</label>
                <input type="text" id="customerCity2d" value="İstanbul" required>
            </div>
            <div class="form-group">
                <label>İlçe:</label>
                <input type="text" id="customerState2d" value="Beykoz" required>
            </div>
            
            <h3>Kart Bilgileri</h3>
            <div class="form-group">
                <label>Kart Sahibi:</label>
                <input type="text" id="cardHolder2d" value="Test Kullanici" required>
            </div>
            <div class="form-group">
                <label>Kart Numarası:</label>
                <input type="text" id="cardNumber2d" value="4508034508034509" required>
            </div>
            <div class="form-group">
                <label>Son Kullanma Ayı:</label>
                <select id="cardMonth2d" required>
                    <option value="12" selected>12</option>
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                </select>
            </div>
            <div class="form-group">
                <label>Son Kullanma Yılı:</label>
                <select id="cardYear2d" required>
                    <option value="2026" selected>2026</option>
                    <option value="2025">2025</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
            <div class="form-group">
                <label>CVV:</label>
                <input type="text" id="cardCvv2d" value="123" required>
            </div>
            <div class="form-group">
                <label>Taksit:</label>
                <select id="installments2d">
                    <option value="1" selected>Tek Çekim</option>
                    <option value="2">2 Taksit</option>
                    <option value="3">3 Taksit</option>
                    <option value="6">6 Taksit</option>
                </select>
            </div>
            
            <button type="submit">2D Ödeme Başlat</button>
        </form>
        <div id="result2d"></div>
    </div>

    <!-- 3D Ödeme Test -->
    <div class="section">
        <h2>3. 3D Güvenli Ödeme Testi</h2>
        <form id="payment3dForm">
            <div class="form-group">
                <label>Tutar (TL):</label>
                <input type="number" id="amount3d" value="1.00" step="0.01" min="0.01">
            </div>
            
            <h3>Müşteri Bilgileri</h3>
            <div class="form-group">
                <label>Ad:</label>
                <input type="text" id="customerName3d" value="Test" required>
            </div>
            <div class="form-group">
                <label>Soyad:</label>
                <input type="text" id="customerSurname3d" value="Müşteri" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="customerEmail3d" value="test@calformat.com" required>
            </div>
            <div class="form-group">
                <label>Telefon:</label>
                <input type="text" id="customerPhone3d" value="05551234567" required>
            </div>
            <div class="form-group">
                <label>Adres:</label>
                <input type="text" id="customerAddress3d" value="Test Adresi 123" required>
            </div>
            <div class="form-group">
                <label>Şehir:</label>
                <input type="text" id="customerCity3d" value="İstanbul" required>
            </div>
            <div class="form-group">
                <label>İlçe:</label>
                <input type="text" id="customerState3d" value="Beykoz" required>
            </div>
            
            <h3>Kart Bilgileri</h3>
            <div class="form-group">
                <label>Kart Sahibi:</label>
                <input type="text" id="cardHolder3d" value="Test Kullanici" required>
            </div>
            <div class="form-group">
                <label>Kart Numarası:</label>
                <input type="text" id="cardNumber3d" value="4508034508034509" required>
            </div>
            <div class="form-group">
                <label>Son Kullanma Ayı:</label>
                <select id="cardMonth3d" required>
                    <option value="12" selected>12</option>
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                </select>
            </div>
            <div class="form-group">
                <label>Son Kullanma Yılı:</label>
                <select id="cardYear3d" required>
                    <option value="2026" selected>2026</option>
                    <option value="2025">2025</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
            <div class="form-group">
                <label>CVV:</label>
                <input type="text" id="cardCvv3d" value="123" required>
            </div>
            <div class="form-group">
                <label>Taksit:</label>
                <select id="installments3d">
                    <option value="1" selected>Tek Çekim</option>
                    <option value="2">2 Taksit</option>
                    <option value="3">3 Taksit</option>
                    <option value="6">6 Taksit</option>
                </select>
            </div>
            
            <button type="submit">3D Güvenli Ödeme Başlat</button>
        </form>
        <div id="result3d"></div>
    </div>

    <!-- Test Bilgileri -->
    <div class="section">
        <h2>4. Test Kartları ve Bilgiler</h2>
        <p><strong>SiPay Test Kartları:</strong></p>
        <ul>
            <li><strong>Visa:</strong> 4508034508034509</li>
            <li><strong>Mastercard:</strong> 5406675406675403</li>
            <li><strong>Test CVV:</strong> 123</li>
            <li><strong>Test Tarih:</strong> 12/2026</li>
        </ul>
        <p><strong>Önemli Notlar:</strong></p>
        <ul>
            <li>✅ calformat.com domain'i çalışıyor</li>
            <li>✅ SiPay ödeme sistemi hazır</li>
            <li>✅ 3D ödeme return URL'si aktif</li>
            <li>Test modunda hash key doğrulama atlanabilir</li>
        </ul>
    </div>

    <script>
        // 2D Ödeme Form Handler
        document.getElementById('payment2dForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultDiv = document.getElementById('result2d');
            resultDiv.innerHTML = '<div class="result info">İşleniyor...</div>';
            
            const paymentData = {
                action: 'start_2d_payment',
                amount: parseFloat(document.getElementById('amount2d').value),
                customer: {
                    name: document.getElementById('customerName2d').value,
                    surname: document.getElementById('customerSurname2d').value,
                    email: document.getElementById('customerEmail2d').value,
                    phone: document.getElementById('customerPhone2d').value,
                    address1: document.getElementById('customerAddress2d').value,
                    address2: '',
                    city: document.getElementById('customerCity2d').value,
                    state: document.getElementById('customerState2d').value,
                    country: 'TR'
                },
                card: {
                    holder_name: document.getElementById('cardHolder2d').value,
                    number: document.getElementById('cardNumber2d').value.replace(/\s/g, ''),
                    expiry_month: document.getElementById('cardMonth2d').value,
                    expiry_year: document.getElementById('cardYear2d').value,
                    cvv: document.getElementById('cardCvv2d').value
                },
                installments: parseInt(document.getElementById('installments2d').value)
            };
            
            try {
                const response = await fetch('/sipay_payment.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>2D Ödeme Başarılı!</h3>
                            <p><strong>Fatura ID:</strong> ${result.invoice_id}</p>
                            <p><strong>İkas Sipariş:</strong> ${result.ikas_order?.success ? 'Oluşturuldu' : 'Hata: ' + (result.ikas_order?.error || 'Bilinmeyen hata')}</p>
                            ${result.ikas_order?.order_number ? `<p><strong>Sipariş No:</strong> ${result.ikas_order.order_number}</p>` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>2D Ödeme Başarısız</h3>
                            <p><strong>Hata:</strong> ${result.error}</p>
                            <p><strong>Detay:</strong> ${result.details || 'Detay yok'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>Bağlantı Hatası</h3>
                        <p>Sunucuya bağlanılamadı: ${error.message}</p>
                    </div>
                `;
            }
        });

        // 3D Ödeme Form Handler
        document.getElementById('payment3dForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultDiv = document.getElementById('result3d');
            resultDiv.innerHTML = '<div class="result info">İşleniyor...</div>';
            
            const paymentData = {
                action: 'start_3d_payment',
                amount: parseFloat(document.getElementById('amount3d').value),
                customer: {
                    name: document.getElementById('customerName3d').value,
                    surname: document.getElementById('customerSurname3d').value,
                    email: document.getElementById('customerEmail3d').value,
                    phone: document.getElementById('customerPhone3d').value,
                    address1: document.getElementById('customerAddress3d').value,
                    address2: '',
                    city: document.getElementById('customerCity3d').value,
                    state: document.getElementById('customerState3d').value,
                    country: 'TR'
                },
                card: {
                    holder_name: document.getElementById('cardHolder3d').value,
                    number: document.getElementById('cardNumber3d').value.replace(/\s/g, ''),
                    expiry_month: document.getElementById('cardMonth3d').value,
                    expiry_year: document.getElementById('cardYear3d').value,
                    cvv: document.getElementById('cardCvv3d').value
                },
                installments: parseInt(document.getElementById('installments3d').value)
            };
            
            try {
                // Test için debug endpoint'e gönder
                const response = await fetch('/test_request.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                // Debug için sonucu göster
                resultDiv.innerHTML = `
                    <div class="result info">
                        <h3>Debug Sonucu:</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                return;
                
                if (result.success) {
                    // 3D Form'u kullanıcıya göster
                    if (result.redirect_form) {
                        resultDiv.innerHTML = `
                            <div class="result success">
                                <h3>3D Güvenli Ödeme Başlatıldı</h3>
                                <p><strong>Fatura ID:</strong> ${result.invoice_id}</p>
                                <p>3D doğrulama sayfasına yönlendiriliyorsunuz...</p>
                                <div style="display: none;">${result.redirect_form}</div>
                            </div>
                        `;
                        
                        // 3D Form'u otomatik submit et
                        setTimeout(() => {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = result.redirect_form;
                            const form = tempDiv.querySelector('form');
                            if (form) {
                                document.body.appendChild(form);
                                form.submit();
                            }
                        }, 2000);
                    } else {
                        resultDiv.innerHTML = `
                            <div class="result error">
                                <h3>3D Form Bulunamadı</h3>
                                <p>SiPay'dan 3D form alınamadı.</p>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>3D Ödeme Başarısız</h3>
                            <p><strong>Hata:</strong> ${result.error}</p>
                            <p><strong>Detay:</strong> ${result.details || 'Detay yok'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>Bağlantı Hatası</h3>
                        <p>Sunucuya bağlanılamadı: ${error.message}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
